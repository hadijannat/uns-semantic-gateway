version: '3.8'

services:
  # 1. The Unified Namespace Broker
  mosquitto:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf
    healthcheck:
      test: [ "CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -W 1 || exit 1" ]
      interval: 5s
      timeout: 3s
      retries: 3

  # 2. The Semantic Gateway (Your Application)
  gateway:
    build: .
    depends_on:
      mosquitto:
        condition: service_healthy
    volumes:
      - ./config:/app/config
    # Enable Rich colors in Docker logs
    tty: true

  # 3. Legacy PLC Simulator (The "Bad Actor")
  simulator:
    build: .
    depends_on:
      mosquitto:
        condition: service_healthy
    command: [ "python", "tools/simulator.py" ]
    volumes:
      - ./tools:/app/tools
    tty: true
